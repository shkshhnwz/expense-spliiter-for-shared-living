<%- include('../partials/mainhead') %>
<%- include('../partials/navbar') %>

<div class="container py-4 py-sm-5 mobile-center">
    <div class="row justify-content-center">
        <div class="col-12 col-md-9 col-lg-7">
            <h2 class="inter-header text-center mb-4">Add New Expense</h2>

            <form action="/dashboard/splits" class="needs-validation" method="post" id="splitForm">

                <div class="card mb-3 shadow-sm border-primary">
                    <div class="card-header bg-primary text-white text-center">Expense Context</div>
                    <div class="card-body">
                        <div class="row g-3 justify-content-center mb-3">
                            <div class="col-auto">
                                <div class="btn-group" role="group">
                                    <input type="radio" class="btn-check" name="expenseType" id="typePersonal" value="personal" checked>
                                    <label class="btn btn-outline-primary" for="typePersonal">
                                        <i class="fas fa-user"></i> Personal
                                    </label>
                                    
                                    <input type="radio" class="btn-check" name="expenseType" id="typeGroup" value="group">
                                    <label class="btn btn-outline-primary" for="typeGroup">
                                        <i class="fas fa-users"></i> Group Split
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div id="group-selection-container" style="display: none;">
                            <label for="groupId" class="form-label fw-bold">Select Group</label>
                            <select class="form-select" name="groupId" id="groupId">
                                <option value="" disabled selected>-- Choose a Group --</option>
                                <% if (typeof groups !== 'undefined' && groups.length > 0) { %>
                                    <% groups.forEach(group => { %>
                                        <option value="<%= group._id %>"><%= group.name %></option>
                                    <% }) %>
                                <% } else { %>
                                    <option value="" disabled>No groups found.</option>
                                <% } %>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="card mb-3 shadow-sm">
                    <div class="card-header text-white bg-purple text-center">Expense Details</div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="splitName" class="form-label">Description</label>
                            <input class="form-control" type="text" name="splitName" id="splitName"
                                placeholder="(e.g. Grocery, Rent, Dinner)" required>
                        </div>
                        <div class="row g-2">
                            <div class="col-md-6 mb-3 mb-md-0">
                                <label for="payableAmount" class="form-label">Total Amount</label>
                                <input class="form-control" type="number" step="0.01" name="payableAmount"
                                    id="payableAmount" placeholder="0.00" required>
                            </div>
                            <div class="col-md-6">
                                <label for="dateofExpense" class="form-label">Date</label>
                                <input class="form-control" type="date" name="dateofExpense" id="dateofExpense"
                                    required>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="personal-expense-logic" style="display: none;">
                    
                    <div class="card mb-3 shadow-sm">
                        <div class="card-header text-white bg-purple text-center">How to split?</div>
                        <div class="card-body">
                            <label for="splitMethod" class="form-label">Select Split Method</label>
                            <select class="form-select" name="splitMethod" id="splitMethod">
                                <option value="equal" selected>Split Equally</option>
                                <option value="amount">By Exact Amounts</option>
                                <option value="percentage">By Percentage</option>
                                <option value="shares">By Shares</option>
                            </select>
                        </div>
                    </div>

                    <div class="card mb-3 shadow-sm">
                        <div class="card-header text-white bg-purple text-center">Splitter Details</div>
                        <div class="card-body">
                            <p class="text-muted small">The payer (You) is included automatically.</p>

                            <div class="mb-3">
                                <label for="numSplitters" class="form-label">Total People (Including You)</label>
                                <input class="form-control" type="number" id="numSplitters" min="1" value="1">
                            </div>

                            <div id="splitter-fields-container">
                                </div>
                        </div>
                    </div>

                </div>

                <div id="group-expense-logic" style="display: none;">
                    
                    <div class="card mb-3 shadow-sm">
                        <div class="card-header text-white bg-purple text-center">How to split?</div>
                        <div class="card-body">
                            <label for="groupSplitMethod" class="form-label">Select Split Method</label>
                            <select class="form-select" name="groupSplitMethod" id="groupSplitMethod">
                                <option value="equal" selected>Split Equally</option>
                                <option value="amount">By Exact Amounts</option>
                                <option value="percentage">By Percentage</option>
                                <option value="shares">By Shares</option>
                            </select>
                        </div>
                    </div>

                </div>

                <div class="text-center mt-4">
                    <button type="submit" class="btn btn-primary btn-lg">Save Transaction</button>
                </div>
            </form>
        </div>
    </div>
</div>

<%- include('../partials/footer') %>

<script>
document.addEventListener('DOMContentLoaded', () => {
    
    // --- DOM Elements ---
    const container = document.getElementById('splitter-fields-container');
    const numSplittersInput = document.getElementById('numSplitters');
    const payableAmountInput = document.getElementById('payableAmount');
    const splitMethodSelect = document.getElementById('splitMethod');
    
    // Toggle Elements
    const typePersonal = document.getElementById('typePersonal');
    const typeGroup = document.getElementById('typeGroup');
    const groupSelectionContainer = document.getElementById('group-selection-container');
    const personalExpenseLogic = document.getElementById('personal-expense-logic');
    const groupExpenseLogic = document.getElementById('group-expense-logic');
    const groupSelect = document.getElementById('groupId');

    // --- 1. TOGGLE LOGIC ---
    function handleContextChange() {
        const isPersonal = typePersonal.checked;

        if (isPersonal) {
            // SHOW Personal Logic
            groupSelectionContainer.style.display = 'none';
            personalExpenseLogic.style.display = 'block';
            groupExpenseLogic.style.display = 'none';
            
            // DISABLE group inputs
            groupSelect.disabled = true;
            toggleInputsInElement(groupExpenseLogic, true);
            
            // ENABLE personal inputs
            toggleInputsInElement(personalExpenseLogic, false);
            renderSplitterFields();
            
        } else {
            // SHOW Group Logic
            groupSelectionContainer.style.display = 'block';
            personalExpenseLogic.style.display = 'none';
            groupExpenseLogic.style.display = 'block';
            
            // ENABLE group inputs
            groupSelect.disabled = false;
            toggleInputsInElement(groupExpenseLogic, false);
            
            // DISABLE personal inputs
            toggleInputsInElement(personalExpenseLogic, true);
        }
    }

    // Helper to disable/enable all inputs inside a div
    function toggleInputsInElement(element, shouldDisable) {
        const inputs = element.querySelectorAll('input, select');
        inputs.forEach(input => {
            input.disabled = shouldDisable;
        });
    }

    // Event Listeners for Radio Buttons
    const expenseTypes = document.querySelectorAll('input[name="expenseType"]');
    expenseTypes.forEach(radio => {
        radio.addEventListener('change', handleContextChange);
    });

    // --- 2. SPLITTER GENERATION LOGIC (PERSONAL ONLY) ---

    const generateSplitterRow = (index) => {
        const title = `Splitter ${index + 1}`;
        
        return `
            <div class="row g-2 mb-3 splitter-row">
                <div class="col-12"><p class="mb-1 fw-bold small text-secondary">${title}</p></div>
                <div class="col-md-5">
                    <input type="text" class="form-control" name="splitterNames" placeholder="Name" required>
                </div>
                <div class="col-md-4">
                    <input type="text" class="form-control" name="splitterContact" placeholder="Email/Phone" required>
                </div>
                <div class="col-md-3">
                    <input type="number" step="0.01" class="form-control split-value-input" name="splitValues" placeholder="0.00" required>
                </div>
            </div>
        `;
    };

    const renderSplitterFields = () => {
        // Only run this if we are in Personal mode
        if (!typePersonal.checked) return;

        let count = parseInt(numSplittersInput.value) || 1;
        let rowsToGenerate = count - 1; 

        container.innerHTML = ''; 

        if (rowsToGenerate < 1) {
            container.innerHTML = '<p class="text-muted small text-center mt-2">Just you? Select "Group Split" to add more people.</p>';
            return;
        }

        for (let i = 0; i < rowsToGenerate; i++) {
            container.insertAdjacentHTML('beforeend', generateSplitterRow(i));
        }
        updateSplitValues();
        updateInputBehavior();
    };

    const updateSplitValues = () => {
        const amount = parseFloat(payableAmountInput.value) || 0;
        const method = splitMethodSelect.value;
        const valueInputs = container.querySelectorAll('.split-value-input');
        
        const totalPeople = valueInputs.length + 1;

        if (method === 'equal' && amount > 0 && totalPeople > 0) {
            const equalShare = amount / totalPeople;
            valueInputs.forEach(input => input.value = equalShare.toFixed(2));
        }
    };

    const updateInputBehavior = () => {
        const method = splitMethodSelect.value;
        const valueInputs = container.querySelectorAll('.split-value-input');
        valueInputs.forEach(input => {
            input.readOnly = (method === 'equal');
            input.placeholder = (method === 'percentage') ? '%' : '0.00';
        });
    };

    // Listeners for Personal Split
    numSplittersInput.addEventListener('change', renderSplitterFields);
    numSplittersInput.addEventListener('keyup', renderSplitterFields);
    payableAmountInput.addEventListener('change', updateSplitValues);
    payableAmountInput.addEventListener('keyup', updateSplitValues);
    splitMethodSelect.addEventListener('change', () => {
        updateInputBehavior();
        updateSplitValues();
    });

    // Run once on load
    handleContextChange();
});
</script>